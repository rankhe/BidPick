<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('批次报价明细')" />
</head>
<body class="gray-bg">
<div class="container-div">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>批次信息</h5>
                </div>
                <div class="ibox-content">
                    <div>
                        <span th:text="'批次编号：' + ${batchInfo.batchNo}"></span>
                        <span id="endTimeText" style="margin-left: 20px">投标截止：</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 select-table table-striped">
            <div class="btn-group-sm" id="toolbarQuotes" role="group" style="margin-bottom:10px;">
                <label style="margin-right:10px;">
                    <input type="checkbox" id="onlyAwardedChk"> 仅导出中标用户
                </label>
                <a class="btn btn-warning" shiro:hasPermission="product:history:export" onclick="exportQuotes()">
                    <i class="fa fa-download"></i> 导出报价
                </a>
            </div>
            <table id="product-table"></table>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="alert alert-info">
                展开上表某一行即可查看该产品的报价列表，并可对具体报价执行中标操作。
            </div>
        </div>
    </div>
 </div>
 <th:block th:include="include :: footer" />
 <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
 <script th:inline="javascript">
     var batchId = [[${batchId}]];
     var endTimeVal = [[${batchInfo.endTime}]];
     var itemsPrefix = ctx + "product/batch/items";
     var historyPrefix = ctx + "product/history";
     var itemStaData = [[${@dict.getType('common_status')}]];
     var quoteStaData = [[${@dict.getType('pro_qutation_sta')}]];
     $(function() {
         if(endTimeVal){
             $('#endTimeText').text('投标截止：' + moment(endTimeVal).format('YYYY-MM-DD HH:mm:ss'));
         }
         var options = {
             url: itemsPrefix + "/list",
             showSearch: false,
             showRefresh: false,
             showToggle: false,
             showColumns: false,
             toolbar: "toolbarQuotes",
             queryParams: function(params){
                 params.batchId = batchId;
                 return params;
             },
             detailView: true,
             onExpandRow: function (index, row, $detail) {
                 initQuoteChildTable(index, row, $detail);
             },
             modalName: "批次商品",
             columns: [
                 { checkbox: true },
                 { field: 'name', title: '产品名称' },
                 { field: 'brandName', title: '品牌' },
                 { field: 'categoryName', title: '类别' },
                 { field: 'publishCount', title: '发布数量' },
                 { field: 'lockedCount', title: '已锁定数量' },
                 { field: 'status', title: '状态', formatter:function (value,item){
                         return $.table.selectDictLabel(itemStaData, item.status);
                     }
                 }
             ]
         };
         $('#product-table').bootstrapTable(options);
     });
     function initQuoteChildTable(index, row, $detail){
         var childTable = $detail.html('<table style="table-layout:fixed"></table>').find('table');
         $(childTable).bootstrapTable({
             url: historyPrefix + "/list",
             method: 'post',
             sidePagination: "server",
             contentType: "application/x-www-form-urlencoded",
             queryParams: function(params){
                 params.batchId = batchId;
                 params.prodId = row.prodId;
                 return params;
             },
             columns: [
                 { field: 'id', title: 'ID', visible: false },
                 { field: 'nickName', title: '报价人昵称' },
                 { field: 'quoterUserMobile', title: '报价人手机号' },
                 { field: 'count', title: '报价数量' },
                 { field: 'price', title: '单价' },
                 { field: 'status', title: '状态', formatter:function (value,item){
                         return $.table.selectDictLabel(quoteStaData, item.status);
                     }
                 },
                 { field: 'awardStatus', title: '中标状态', formatter:function(value, item){
                         return value == 1 ? '已中标' : '未中标';
                     }
                 },
                 { title: '操作', align: 'center', formatter:function(value, item){
                         var actions = [];
                         if (item.awardStatus != 1){
                             actions.push('<a class="btn btn-success btn-xs" href="javascript:void(0)" onclick="awardQuote(' + item.id + ', this)">中标</a>');
                         } else {
                             actions.push('<span class="text-muted">已中标</span>');
                         }
                         return actions.join(' ');
                     }
                 }
             ]
         });
     }
     function awardQuote(id, btn){
         $.modal.confirm('确认将该报价设为中标？', function() {
             $.operate.post(historyPrefix + "/award", {id: id}, function(result){
                 $.modal.msgSuccess('设置成功');
                 // 刷新当前子表
                 var $child = $(btn).closest('table');
                 $child.bootstrapTable('refresh');
                 // 同步刷新上表以更新锁定数量
                 $('#product-table').bootstrapTable('refresh');
             });
         });
     }
     function exportQuotes(){
         var onlyAwarded = $('#onlyAwardedChk').prop('checked') ? 1 : 0;
         var dataParam = [{ "name": "batchId", "value": batchId }, { "name": "onlyAwarded", "value": onlyAwarded }];
         $.modal.confirm("确定导出该批次的报价明细吗？", function() {
             $.modal.loading("正在导出数据，请稍候...");
             $.post(historyPrefix + "/export", dataParam, function(result) {
                 if (result.code == web_status.SUCCESS) {
                     window.location.href = ctx + "common/download?fileName=" + encodeURI(result.msg) + "&delete=" + true;
                 } else if (result.code == web_status.WARNING) {
                     $.modal.alertWarning(result.msg)
                 } else {
                     $.modal.alertError(result.msg);
                 }
                 $.modal.closeLoading();
             });
         });
     }
 </script>
</body>
</html>
