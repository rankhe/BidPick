<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改产品信息')" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-info-edit" th:object="${prodInfo}">
            <input name="id" th:field="*{id}" type="hidden">
            <div class="form-group">
                <label class="col-sm-3 control-label">品牌：</label>
                <div class="col-sm-8">
                    <select id="brandName" name="brandName" class="form-control">
                        <option th:each="brand:${brands}" th:value="${brand.name}" th:text="${brand.name}" th:attr="data-id=${brand.id}" th:selected="${brand.name == prodInfo.brandName}"></option>
                    </select>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">产品型号/名称：</label>
                <div class="col-sm-8">
                    <input name="name" th:field="*{name}" class="form-control" type="text" required>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">产品分类：</label>
                <div class="col-sm-8">
                    <select id="categoryId" name="categoryId"  class="form-control">
                        <option th:each="cat:${categories}" th:value="${cat.id}" th:text="${cat.name}"
                                th:selected="${cat.id} == *{categoryId}" onchange="setCategoryName()"></option>
                    </select>
                    <input name="categoryName" id="categoryName" th:field="*{categoryName}" class="form-control" type="hidden" >
<!--                    <input name="categoryName" th:field="*{categoryName}" class="form-control" type="text" required>-->
                </div>
            </div>
<!--            <div class="form-group">    -->
<!--                <label class="col-sm-3 control-label is-required">批次ID：</label>-->
<!--                <div class="col-sm-8">-->
<!--                    <input name="batchNo" th:field="*{batchNo}" class="form-control" type="text" required disabled>-->
<!--                </div>-->
<!--            </div>-->
            <div class="form-group">
                <label class="col-sm-3 control-label">数量：</label>
                <div class="col-sm-8">
                    <input name="count" th:field="*{count}" class="form-control" type="text">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">创建人：</label>
                <div class="col-sm-8">
                    <input name="createBy" th:value="*{createBy}" class="form-control" type="text" disabled>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">创建时间：</label>
                <div class="col-sm-8">
                    <input name="createTime" th:value="${#dates.format(prodInfo.createTime, 'yyyy-MM-dd HH:mm:ss')}" class="form-control" type="text" disabled>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">更新人：</label>
                <div class="col-sm-8">
                    <input name="updateBy" th:value="*{updateBy}" class="form-control" type="text" disabled>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">更新时间：</label>
                <div class="col-sm-8">
                    <input name="updateTime" th:value="${#dates.format(prodInfo.updateTime, 'yyyy-MM-dd HH:mm:ss')}" class="form-control" type="text" disabled>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <script th:inline="javascript">
        var prefix = ctx + "product/info";
        var prodInfo = [[${prodInfo}]];
        
        $("#form-info-edit").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-info-edit').serialize());
            }
        }
        
        $(function(){
            // Only prepend if not selected, or handle it carefully. 
            // Since we want linkage, we should let JS handle initialization if brand is present.
            $("#brandName").prepend("<option value=''>请选择品牌</option>");
            
            var brandNameToId = {};
            $("#brandName option").each(function(){
                var nm = $(this).val();
                var id = $(this).attr("data-id");
                if (nm && id) { brandNameToId[nm] = id; }
            });
            
            $("#brandName").on("change", function(){
                var $opt = $(this).find("option:selected");
                var bid = $opt.attr("data-id") || brandNameToId[$opt.val()];
                if (bid) {
                    loadCategories(bid);
                } else {
                    $("#categoryId").empty().append("<option value='-1'>--无--</option>");
                    $("#categoryName").val("");
                }
            });
            
            // Init linkage state
            if (prodInfo.brandName && brandNameToId[prodInfo.brandName]) {
                 // Load categories for current brand, preserving current selection
                 loadCategories(brandNameToId[prodInfo.brandName], prodInfo.categoryId);
            } else {
                 // If no brand or unknown brand, maybe just leave existing categories or clear?
                 // Existing code loaded all categories. 
                 // If we want strict linkage, we should filter. 
                 // But let's respect the current brand if valid.
                 $("#categoryId").prepend("<option value='-1'>--无--</option>");
            }
        });
        
        function loadCategories(brandId, selectedId){
            var url = ctx + "product/tree/category/" + brandId;
            $.getJSON(url, function(list){
                var $sel = $("#categoryId");
                $sel.empty().append("<option value='-1'>--无--</option>");
                if (Array.isArray(list)) {
                    for (var i = 0; i < list.length; i++) {
                        var c = list[i];
                        $sel.append("<option value='"+ c.id +"'>"+ c.name +"</option>");
                    }
                }
                if (selectedId) {
                    $sel.val(String(selectedId));
                    // Ensure categoryName is synced
                    setCategoryName();
                }
            });
        }
        
        function setCategoryName()
        {
            var categoryId = $("#categoryId").val();
            if(categoryId && categoryId != -1)
            {
                var categoryName = $("#categoryId option:selected").text();
                $("#categoryName").val(categoryName);
            } else {
                $("#categoryName").val("");
            }
        }
    </script>
</body>
</html>
