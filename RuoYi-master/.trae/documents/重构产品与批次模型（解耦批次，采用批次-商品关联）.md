## 目标
- 解耦产品与批次：产品（ProdInfo）不再包含任何批次字段；批次通过“批次-商品关联”管理发布数量与库存锁定。
- 批次发布、报价、中标均围绕“批次-商品项”运作，满足“一次选择多个产品并填写数量”的需求。

## 数据模型调整
- 保留：`ProdInfo` 作为全局产品模板，字段去除 `batchId/batchNo`。
- 新增：`BatchProduct`（批次-商品项）
  - 字段：`id`、`batch_id`、`prod_id`、`publish_count`、`locked_count`、`idx`、`status`、`create_time`、`update_time`
  - 语义：某批次中的某个产品及其发布数量与预占数量（仅中标后预占）
- 现有：`BatchInfo` 保持不变，描述批次基本信息（编号、时间窗、说明等）
- 报价记录 `ProdQuotationHistory`：
  - 保留 `prod_id`、`batch_id`
  - 推荐新增 `batch_product_id`（指向具体批次-商品项），未来统计与校验以此为主键更稳固。

## 数据库迁移（SQL草案）
- `alter table prod_info drop column batch_id, drop column batch_no;`
- `create table batch_product ( id bigint auto_increment primary key, batch_id bigint not null, prod_id bigint not null, publish_count int not null default 0, locked_count int not null default 0, idx int default 0, status tinyint default 1, create_time timestamp null, update_time timestamp null );`
- 可选：`alter table prod_quotation_history add column batch_product_id bigint null;`

## 后端改造
### 控制器
- 批次发布（运营端）：`BatchInfoController`
  - `POST /product/batch/publish`：创建批次后，按前端提交的 `{prodId, publishCount}` 批量插入 `batch_product`
  - `POST /product/batch/{id}/items`：向已存在批次追加 `batch_product`
  - C 端批次查询 `list/{publish}`：保持现有逻辑，同时按黑名单过滤
- 产品管理：`ProdInfoController`（ruoyi-admin/src/main/java/com/ruoyi/web/controller/product/ProdInfoController.java）
  - 移除与批次相关的读写（当前导出与导入使用 `batchNo` 需改造）
  - `importData`：不再通过 `batchNo` 反查批次，改为纯产品导入（或新增“批次项导入”入口专用于 `batch_product`）
- 报价与中标：`ProdQuotationHistoryController`
  - 报价提交：仅校验“单条报价数量 ≤ 对应 `batch_product.publish_count`”；不占用库存
  - 中标操作：在单次事务中校验 `sum(已中标数量) + 当前中标数量 ≤ publish_count`，通过后更新 `batch_product.locked_count` 与报价 `award_status/award_time`

### Service & Mapper
- 新增 `IBatchProductService/Mapper` 及 XML（`select/list/insert/update`、统计 `sumAwardedCount(batch_product_id)`）
- 更新 `IProdInfoService/Mapper`：删除与批次相关的条件与列（`ProdInfoMapper.xml:28-40` 需去掉 `batch_id/batch_no` 相关部分）
- 更新 `IProdQuotationHistoryService/Mapper`：
  - 新增基于 `batch_product_id` 的统计方法（保留现有按 `prod_id/batch_id` 的实现作为兼容）

## 前端改造
- 批次新增页：`ruoyi-admin/src/main/resources/templates/product/batch/add.html`
  - 商品多选表格数据源指向全局产品 `POST /product/info/list`
  - 每行填写“发布数量”，提交后仅在 `batch_product` 记录数量
- 批次列表页：保持
- 报价列表页：展示“发布数量/已锁定数量”来自 `batch_product`；“设为中标”调用中标接口
- 产品管理页：
  - 去除批次字段展示与编辑
  - 导入页：不再需要 `batchNo` 字段；如需批次导入，另设批次项专用导入页

## 权限与菜单
- 复用既有前缀：`product:info:*`、`product:batch:*`、`product:history:*`
- 新增批次-商品项后台管理（可内嵌在批次编辑页，不单独菜单）

## 兼容与迁移策略
- 迁移脚本先创建 `batch_product`，再逐步从历史数据中回填（如存在 `ProdInfo.batchId/batchNo` 的老数据，可脚本按批次生成对应 `batch_product`），随后移除旧字段
- 前后端改造分步上线，期间保留兼容接口（例如报价统计既支持旧参数也支持新 `batch_product_id`）

## 受影响代码（需要调整）
- 产品控制器与导入/导出：`ruoyi-admin/src/main/java/com/ruoyi/web/controller/product/ProdInfoController.java`（导入使用 `batchNo` 的片段：约 `235-247`）
- 产品实体：`ruoyi-system/src/main/java/com/ruoyi/product/domain/ProdInfo.java`（移除 `batchId/batchNo` 字段）
- 产品 Mapper：`ruoyi-system/src/main/resources/mapper/product/ProdInfoMapper.xml`（移除与批次相关列与条件）
- 报价控制器：`ruoyi-admin/src/main/java/com/ruoyi/web/controller/product/ProdQuotationHistoryController.java`（中标校验改为基于批次项）

## 验收标准
- 批次发布时可一次选择多个产品并填写发布数量，成功保存为 `batch_product`
- 报价阶段只做数量上限校验；中标后锁定数量正确，且总中标数量不超过发布数量
- 产品页面不再出现批次相关信息；批次页面与报价页面按批次项数据工作

我将按上述方案实施：优先完成数据库建模与后端接口改造，其后调整前端页面与导入逻辑，最后提供迁移脚本与验证步骤。请确认该方案。